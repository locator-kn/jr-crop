/**
 * jr-crop - A simple ionic plugin to crop your images.
 * @version 1.0.0
 * @link https://github.com/locator-kn/jr-crop-locator
 * @author Joram Ruitenschild, Timotheus Ruprecht
 * @license MIT
 */
angular.module("jrCrop",[]).factory("$jrCrop",["$ionicModal","$rootScope","$q",function(t,i,e){var s='<div class="jr-crop modal"><div class="jr-crop-center-container"><div class="jr-crop-img" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="jr-crop-center-container"><div class="jr-crop-select" style="overflow: hidden" ng-style="{width: width + \'px\', height: height + \'px\'}"></div></div><div class="bar bar-footer bar-dark jr-crop-footer"><button class="button button-clear" ng-click="cancel()">{{cancelText}}</button><div class="title">{{title}}</div><button class="button button-clear" ng-click="crop()">{{chooseText}}</button></div></div>',o=ionic.views.View.inherit({promise:null,imgWidth:null,imgHeight:null,imgSelect:null,imgFull:null,posX:0,posY:0,scale:1,last_scale:1,last_posX:0,last_posY:0,initialize:function(t){var i=this;i.options=t,i.promise=e.defer(),i.loadImage().then(function(t){i.imgWidth=t.naturalWidth,i.imgHeight=t.naturalHeight,i.options.modal.el.querySelector(".jr-crop-img").appendChild(i.imgSelect=t.cloneNode()),i.options.modal.el.querySelector(".jr-crop-select").appendChild(i.imgFull=t.cloneNode()),i.bindHandlers(),i.initImage()}),i.options.cancel=this.cancel.bind(this),i.options.crop=this.crop.bind(this)},initImage:function(){if(this.options.height<this.imgHeight||this.options.width<this.imgWidth){var t=this.imgWidth/this.imgHeight,i=this.options.width/this.options.height;this.scale=this.last_scale=i>t?this.options.width/this.imgWidth:this.options.height/this.imgHeight}var e=(this.imgWidth-this.options.width)/2,s=(this.imgHeight-this.options.height)/2;this.posX=this.last_posX=-e,this.posY=this.last_posY=-s,this.setImageTransform()},cancel:function(){var t=this;t.options.modal.remove().then(function(){t.promise.reject("canceled")})},bindHandlers:function(){function t(){i(),s.posX>o&&(s.posX=o),s.posX<a&&(s.posX=a),s.posY>h&&(s.posY=h),s.posY<n&&(s.posY=n)}function i(){var t=s.scale*s.imgWidth,i=s.scale*s.imgHeight;o=(t-s.imgWidth)/2,h=(i-s.imgHeight)/2,a=-(t-o-s.options.width),n=-(i-h-s.options.height)}var e,s=this,o=0,h=0,a=0,n=0,r=0,l=0,c=1,d=s.imgWidth/s.imgHeight,g=s.options.width/s.options.height;e=d>g?s.options.height/s.imgHeight:s.options.width/s.imgWidth;var p={prevent_default_directions:["left","right","up","down"]};ionic.onGesture("touch transform drag dragstart dragend",function(i){switch(i.type){case"touch":s.last_scale=s.scale;break;case"drag":s.posX=s.last_posX+i.gesture.deltaX-r,s.posY=s.last_posY+i.gesture.deltaY-l,t();break;case"transform":s.scale=Math.max(e,Math.min(s.last_scale*i.gesture.scale,c)),t();break;case"dragend":s.last_posX=s.posX,s.last_posY=s.posY;break;case"dragstart":s.last_scale=s.scale,i.gesture.deltaX>1||i.gesture.deltaX<-1?(r=i.gesture.deltaX,l=i.gesture.deltaY):(r=0,l=0)}s.setImageTransform()},s.options.modal.el,p)},setImageTransform:function(){var t=this,i="translate3d("+t.posX+"px,"+t.posY+"px, 0) scale3d("+t.scale+","+t.scale+", 1)";t.imgSelect.style[ionic.CSS.TRANSFORM]=i,t.imgFull.style[ionic.CSS.TRANSFORM]=i},crop:function(){var t=document.createElement("canvas"),i=t.getContext("2d");t.width=this.options.width/this.scale,t.height=this.options.height/this.scale;var e=this.imgWidth*this.scale,s=this.imgHeight*this.scale,o=(e-this.imgWidth)/2,h=(s-this.imgHeight)/2,a=(this.posX-o)/this.scale,n=(this.posY-h)/this.scale;if(this.options.getOnlyData){var r=Math.abs(a),l=Math.abs(n),c=this.options.width*this.imgWidth/e,d=this.options.height*this.imgHeight/s;this.options.roundData&&(r=Math.floor(r),l=Math.floor(l),c=Math.floor(c),d=Math.floor(d),this.imgWidth=Math.floor(this.imgWidth),this.imgHeight=Math.floor(this.imgHeight));var g={x:r,y:l,width:c,height:d,originWidth:this.imgWidth,originHeight:this.imgHeight,src:this.imgSelect.src};return this.options.modal.remove(),this.promise.resolve(g)}i.drawImage(this.imgFull,a,n),this.options.modal.remove(),this.promise.resolve(t)},loadImage:function(){var t=e.defer();return angular.element("<img />").bind("load",function(){t.resolve(this)}).bind("error",t.reject).prop("src",this.options.url),t.promise}});return{defaultOptions:{width:0,height:0,aspectRatio:0,cancelText:"Cancel",chooseText:"Choose",getOnlyData:!1,roundData:!1},crop:function(e){e=this.initOptions(e);var h=i.$new(!0);return ionic.extend(h,e),h.modal=t.fromTemplate(s,{scope:h}),h.modal.show().then(function(){return new o(h).promise.promise})},initOptions:function(t){var i;return i=ionic.extend({},this.defaultOptions),i=ionic.extend(i,t),i.aspectRatio&&(!i.width&&i.height&&(i.width=200),i.width?i.height=i.width/i.aspectRatio:i.height&&(i.width=i.height*i.aspectRatio)),i}}}]);